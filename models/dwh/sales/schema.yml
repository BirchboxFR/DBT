version: 2

models:
  - name: box_sales
    description: |
      Table des ventes d'abonnements box. Une ligne = un abonné pour un mois donné.
      Cette table contient l'historique complet des abonnements avec les informations de paiement,
      statut d'acquisition, raisons de churn et métriques de performance.
      Clé de jointure : user_key (avec user.customers et autres tables user).
    columns:
      - name: user_key
        description: "Clé unique de l'utilisateur au format pays/user_id (ex : FR_12345). Utilisée pour les jointures avec les tables user."
      - name: dw_country_code
        description: "Code pays de l'utilisateur (FR, DE, ES, IT, BE, PT, etc.)."
      - name: sub_id
        description: "Identifiant unique de l'abonnement."
      - name: order_detail_id
        description: "Identifiant du détail de commande."
      - name: crm_acquisition
        description: "Indicateur si l'utilisateur est une acquisition CRM (true/false)."
      - name: order_id
        description: "Identifiant de la commande."
      - name: user_id
        description: "Identifiant numérique de l'utilisateur."
      - name: box_id
        description: "Identifiant de la box reçue ce mois-ci."
      - name: is_current
        description: "Booléen indiquant si c'est la box du mois en cours."
      - name: diff_current_box
        description: "Différence entre la box actuelle et la box du mois en cours. Filtrer sur BETWEEN -24 AND 1 pour les analyses de churn."
      - name: coffret_id
        description: "Identifiant du coffret (variation de produits) reçu par l'abonné."
      - name: date
        description: "Date de la box au format DATE (année-mois-01). Correspond au mois de l'abonnement."
      - name: reexp
        description: "Booléen indiquant si la box a été réexpédiée."
      - name: mini_reexp
        description: "Booléen indiquant si une mini réexpédition a eu lieu."
      - name: day_in_cycle
        description: "Jour dans le cycle de paiement (1-31)."
      - name: payment_date
        description: "Date réelle du paiement (jour précis)."
      - name: nb_days_since_opening
        description: "Nombre de jours depuis l'ouverture du cycle de paiement."
      - name: nb_days_next_cycle
        description: "Nombre de jours jusqu'au prochain cycle."
      - name: month
        description: "Mois de la box (1-12)."
      - name: year
        description: "Année de la box."
      - name: coupon_code_id
        description: "Identifiant du code promo utilisé."
      - name: coupon_code
        description: "Code promo utilisé pour cette order_detail. Se répète pour les box futures."
      - name: sub_offer_id
        description: "Identifiant de l'offre d'abonnement."
      - name: sub_offer_code
        description: "Code de l'offre d'abonnement."
      - name: coupon
        description: "Coupon appliqué uniquement sur ce mois (différent de coupon_code)."
      - name: reactivated_date
        description: "Date et heure de réactivation de l'abonnement (si applicable)."
      - name: shipping_mode
        description: "Mode de livraison (jointure avec la table shipping_modes)."
      - name: self
        description: "Indicateur de self."
      - name: gift
        description: "Indicateur d'abonnement cadeau (1 = cadeau, 0 = normal)."
      - name: yearly
        description: "Indicateur d'abonnement annuel actuel (1 = annuel, 0 = mensuel)."
      - name: dquantity
        description: "Quantité d'engagement (nombre de mois)."
      - name: cannot_suspend
        description: "Indicateur si l'abonnement ne peut pas être suspendu (1 = engagé, 0 = suspendable)."
      - name: total_product
        description: "Montant total des produits HT."
      - name: store_code
        description: "Code du store (FR, DE, ES, etc.)."
      - name: vat_rate
        description: "Taux de TVA appliqué (ex : 20.0)."
      - name: total_discount
        description: "Montant total des réductions HT."
      - name: shipping_country
        description: "Pays de livraison (code ISO)."
      - name: total_shipping
        description: "Montant total de la livraison HT."
      - name: payment_status
        description: "Statut du paiement (paid, forthcoming)."
      - name: sub_payment_status
        description: "Libellé du statut de paiement de l'abonnement."
      - name: sub_payment_status_id
        description: "Identifiant du statut de paiement de l'abonnement."
      - name: sub_start_box
        description: "ID de la première box reçue par l'abonné."
      - name: raffed
        description: "Indicateur si l'abonné a été parrainé (1 = oui, 0 = non)."
      - name: raf_parent_id
        description: "Identifiant du parrain (si applicable)."
      - name: shipping_firstname
        description: "Prénom de livraison."
      - name: shipping_lastname
        description: "Nom de livraison."
      - name: gift_card_id
        description: "Identifiant de la carte cadeau utilisée."
      - name: discount_type
        description: "Type de réduction appliquée (Coupon, Other, etc.)."
      - name: coupon_engagement
        description: "Type d'engagement du coupon (engaged, not engaged)."
      - name: coop
        description: "Montant des coûts produits."
      - name: assembly_cost
        description: "Coût d'assemblage de la box."
      - name: pack_cost
        description: "Coût d'emballage."
      - name: print_cost
        description: "Coût d'impression."
      - name: consumable_cost
        description: "Coût des consommables."
      - name: shipping_cost
        description: "Coût de livraison."
      - name: next_month_date
        description: "Date du mois suivant (format DATE)."
      - name: next_payment_date
        description: "Date du prochain paiement prévu."
      - name: last_payment_date
        description: "Date du dernier paiement effectué."
      - name: last_committed_box
        description: "Dernière box sous engagement."
      - name: is_mono
        description: "Booléen indiquant si c'est une box mono-marque."
      - name: mono_brand
        description: "Nom de la marque si box mono-marque."
      - name: next_month_id
        description: "ID de la box du mois suivant."
      - name: last_box_received_date
        description: "Date de réception de la dernière box."
      - name: next_month_status
        description: "Statut de la prochaine box (LIVE ou CHURN)."
      - name: next_month_committment
        description: "Indique l'engagement du client pour le mois suivant."
      - name: is_new_sequence
        description: "Indique si l'abonnement correspond à une nouvelle séquence."
      - name: total_boxes_so_far
        description: "Nombre total de box reçues jusqu'à présent."
      - name: sub_suspended_reason_lvl1
        description: "Raison principale de suspension (technical, gift end ou self-willed)."
      - name: sub_suspended_reason_lvl2
        description: "Raison secondaire de suspension (paused, suspended, gift end, breakage, expired card, etc.)."
      - name: sub_suspended_reason_lvl3
        description: "Raison tertiaire de suspension (jointure avec sub_suspended_reasons)."
      - name: box_global_grade
        description: "Note globale attribuée à la box."
      - name: coupon_type
        description: "Type de coupon appliqué à la commande."
      - name: acquis_status_lvl1
        description: "Niveau 1 du statut d'acquisition (LIVE, ACQUISITION)."
      - name: acquis_status_lvl2
        description: "Niveau 2 du statut d'acquisition (LIVE, NEWNEW, REACTIVATION, GIFT, etc.)."
      - name: committed
        description: "Indique si le client est engagé à recevoir une box."
      - name: gws_costs
        description: "Coûts liés aux produits GWS."
      - name: gross_revenue
        description: "Revenu brut généré."
      - name: vat_on_gross_revenue
        description: "TVA appliquée sur le revenu brut."
      - name: discount
        description: "Montant des réductions appliquées."
      - name: vat_on_discount
        description: "TVA appliquée sur la réduction."
      - name: net_revenue
        description: "Revenu net après réductions."
      - name: shipping
        description: "Coût de livraison associé à la box."
      - name: vat_on_shipping
        description: "TVA appliquée sur les frais de livraison."
      - name: gross_profit
        description: "Marge brute après coûts et remises."
      - name: sequence_group
        description: "Groupe de séquence de l'abonnement."
      - name: committment_status
        description: "Statut de l'engagement du client."
      - name: consecutive_boxes
        description: "Nombre de box consécutives reçues sans interruption."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - sub_id
            - dw_country_code
          severity: warn
          config:
            store_failures: true
            name: "Doublons box_sales"

  - name: "shop_sales"
    description: "Ventes e-shop hors box — une ligne correspond à un produit (item) d’une commande shop."
    columns:

      - name: "user_key"
        description: "Clé utilisateur (dérivée/obfusquée) associée à la commande."

      - name: "dw_country_code"
        description: "Code pays du site de vente (FR, DE, ES, …)."

      - name: "order_id"
        description: "Identifiant de la commande e-shop (niveau commande)."

      - name: "user_id"
        description: "Identifiant interne de l’utilisateur (numérique)."

      - name: "order_status"
        description: "Statut de la commande (ex: paid, shipped, cancelled…)."

      - name: "is_active_sub"
        description: "Utilisateur abonné actif au moment de la commande (0/1)."

      - name: "is_first_order"
        description: "Vrai si c’est la première commande de l’utilisateur (0/1)."

      - name: "is_first_shop_order"
        description: "Vrai si c’est la première commande e-shop (hors box) (0/1)."

      - name: "order_date"
        description: "Date de la commande (UTC ou tz boutique)."

      - name: "product_id"
        description: "Identifiant produit (catalogue)."

      - name: "sku"
        description: "SKU de l’article vendu."

      - name: "product_name"
        description: "Nom du produit à la vente."

      - name: "store_code"
        description: "Store pour la boutique montmartre sinon FR, DE, ES…"

      - name: "store_id"
        description: "Identifiant numérique de la boutique/canal."

      - name: "vat_rate"
        description: "Taux de TVA appliqué sur la ligne (ex: 0.20)."

      - name: "product_codification_id"
        description: "Identifiant de codification/typologie produit (référence interne)."

      - name: "product_codification"
        description: "Libellé de la classification commande/produit (ex: ESHOP, LTE…)."

      - name: "planning_category_1"
        description: "Catégorie (niveau 1) pour le pilotage merchandising/planning."

      - name: "unit_price"
        description: "Prix unitaire TTC avant remises."

      - name: "quantity"
        description: "Quantité vendue pour ce SKU dans la commande."

      - name: "unit_product_discount"
        description: "Remise unitaire liée au produit (TTC)."

      - name: "unit_coupon_discount"
        description: "Remise unitaire liée au coupon (TTC)."

      - name: "unit_sub_discount"
        description: "Remise unitaire liée à l’abonnement (TTC)."

      - name: "unit_points_discount"
        description: "Remise unitaire liée aux points/fidélité (TTC)."

      - name: "unit_store_discount"
        description: "Remise unitaire liée au magasin/canal (TTC)."

      - name: "brand_name"
        description: "Marque du produit."

      - name: "brand_group"
        description: "Groupe de marques (regroupement business)."

      - name: "is_in_house"
        description: "Produit maison / marque propre (0/1)."

      - name: "gift_card_type"
        description: "Type de carte cadeau s’il s’agit d’un gift card (sinon NULL)."

      - name: "gift_card_duration"
        description: "Durée en mois pour une carte cadeau (mois)"

      - name: "order_coupon_code"
        description: "Code coupon appliqué au niveau commande (si présent)."

      - name: "order_total_shipping_ttc"
        description: "Montant TTC total des frais de port sur la commande."

      - name: "order_shipping_mode_name"
        description: "Mode d’expédition au niveau de la commande (libellé)."

      - name: "shipping_mode_id"
        description: "Identifiant du mode d’expédition."

      - name: "detail_valid"
        description: "Drapeau de validité de la ligne (0/1)."

      - name: "euro_purchase_price"
        description: "Prix d’achat unitaire en euros (hors taxes si base supply)."

      - name: "products_cost"
        description: "Coût total des produits sur la ligne (euro_purchase_price × quantity)."

      - name: "bundle_product_id"
        description: "Identifiant du bundle si l’article fait partie d’un lot (sinon NULL)."

      - name: "bundle_index"
        description: "Position de l’article dans le bundle (si applicable)."

      - name: "shipping_country"
        description: "Pays de livraison (ISO)."

      - name: "selections"
        description: "les corners en gros"

      - name: "year"
        description: "Année civil de la commande (numérique)."

      - name: "month"
        description: "Mois de la commande (1–12)."

      - name: "gross_revenue"
        description: "Chiffre d’affaires brut ligne (unit_price × quantity)."

      - name: "vat_on_gross_revenue"
        description: "TVA collectée sur le CA brut de la ligne."

      - name: "total_discount"
        description: "Remises totales ligne (somme des remises unitaires × quantity)."

      - name: "vat_on_total_discount"
        description: "TVA associée aux remises de la ligne."

      - name: "product_discount"
        description: "Total remise produit (agrégée sur la ligne)."

      - name: "points_discount"
        description: "Total remise points/fidélité (agrégée sur la ligne)."

      - name: "coupons_discount"
        description: "Total remise coupons (agrégée sur la ligne)."

      - name: "store_discount"
        description: "Total remise magasin/canal (agrégée sur la ligne)."

      - name: "sub_discount"
        description: "Total remise abonnement (agrégée sur la ligne)."

      - name: "order_total_shipping"
        description: "Frais de port totaux HT au niveau de la commande (si distinct)."

      - name: "vat_on_total_shipping"
        description: "TVA sur les frais de port totaux."

      - name: "net_revenue"
        description: "Chiffre d’affaires net ligne (gross_revenue − total_discount)."

      - name: "sell_out"
        description: "Drapeau/valeur sell-out (logique retail), si alimenté."
