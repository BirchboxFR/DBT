# ==========================================
# MÉTRIQUES RAF (Refer-A-Friend / Parrainage)
# ==========================================
# À ajouter dans votre projet dbt à côté du semantic model box_sales_semantic
# Termes: RAF, Parrainage, Parrain, Marraine, Filleul(e), Referer, Referred

metrics:
  # ========================================
  # 1. ACQUISITIONS RAF
  # ========================================

  - name: raf_acquisitions
    label: "Acquisitions RAF (Parrainages)"
    description: |
      Nombre de nouvelles acquisitions via parrainage (raffed = 1).
      Inclut uniquement les nouvelles acquisitions payées (pas les LIVE).
      Termes: parrainés, filleuls, referred clients
    type: simple
    type_params:
      measure: nb_subscriptions
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__acquis_status_lvl1') }} <> 'LIVE'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'

  - name: raf_daily_acquisitions
    label: "Acquisitions RAF quotidiennes"
    description: "Nombre d'acquisitions RAF par jour (basé sur payment_date)"
    type: simple
    type_params:
      measure: nb_subscriptions
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__acquis_status_lvl1') }} <> 'LIVE'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'

  - name: raf_new_acquisitions
    label: "Nouvelles acquisitions RAF (NEW NEW)"
    description: "Acquisitions RAF de type NEW NEW uniquement (pas de réactivations)"
    type: simple
    type_params:
      measure: nb_subscriptions
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__acquis_status_lvl2') }} = 'NEW NEW'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'

  - name: raf_reactivations
    label: "Réactivations RAF"
    description: "Réactivations d'anciens clients via parrainage"
    type: simple
    type_params:
      measure: nb_subscriptions
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__acquis_status_lvl2') }} = 'REACTIVATION'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'

  # ========================================
  # 2. UTILISATEURS RAF
  # ========================================

  - name: raf_unique_users
    label: "Nombre de filleuls uniques"
    description: |
      Nombre d'utilisateurs uniques parrainés.
      Compte chaque filleul une seule fois même s'il a plusieurs boxes.
    type: simple
    type_params:
      measure: nb_unique_users
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'

  # Note: Pour compter les parrains, il faudrait une jointure avec raf_parent_id
  # qui n'est pas dans le semantic model actuel. À ajouter si besoin.

  

  # ========================================
  # 4. MARGES RAF
  # ========================================

  - name: raf_gross_profit
    label: "Marge brute RAF"
    description: "Marge brute totale générée par les clients parrainés"
    type: simple
    type_params:
      measure: total_gross_profit
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'

  - name: raf_avg_gross_profit
    label: "Marge brute moyenne RAF"
    description: "Marge brute moyenne par subscription des clients parrainés"
    type: simple
    type_params:
      measure: avg_gross_profit
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'


  # ========================================
  # 6. CHURN RAF
  # ========================================

  - name: raf_churn_count
    label: "Nombre de churns RAF"
    description: |
      Nombre de clients parrainés qui churn (next_month_status = 'CHURN').
      Utilise next_month_date comme dimension temporelle.
    type: simple
    type_params:
      measure: nb_subscriptions
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__next_month_status') }} = 'CHURN'

  - name: raf_active_subscriptions
    label: "Subscriptions RAF actives"
    description: "Nombre de subscriptions actives de clients parrainés (LIVE)"
    type: simple
    type_params:
      measure: nb_subscriptions
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__acquis_status_lvl1') }} = 'LIVE'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'

  # ========================================
  # 7. ENGAGEMENT RAF
  # ========================================

  - name: raf_avg_consecutive_boxes
    label: "Moyenne de boxes consécutives RAF"
    description: "Nombre moyen de boxes consécutives pour les clients parrainés"
    type: simple
    type_params:
      measure: avg_consecutive_boxes
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'

  - name: raf_avg_lifetime_boxes
    label: "Moyenne de boxes à vie RAF"
    description: "Nombre moyen de boxes reçues à vie par les clients parrainés"
    type: simple
    type_params:
      measure: avg_total_boxes_so_far
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'

  - name: raf_committed_rate
    label: "Taux d'engagement RAF"
    description: "Pourcentage de clients parrainés avec engagement (committed)"
    type: simple
    type_params:
      measure: nb_subscriptions
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__committed') }} = 'committed'

  # ========================================
  # 8. RÉDUCTIONS RAF
  # ========================================

  - name: raf_total_discount
    label: "Réductions totales RAF"
    description: "Montant total des réductions appliquées aux clients parrainés"
    type: simple
    type_params:
      measure: total_discount
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'

  - name: raf_avg_discount
    label: "Réduction moyenne RAF"
    description: "Réduction moyenne par subscription des clients parrainés"
    type: simple
    type_params:
      measure: avg_discount
    filter: |
      {{ Dimension('box_sales_semantic__raffed') }} = 'Referred'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'


  - name: total_acquisitions
    label: "Total acquisitions"
    description: "Nombre total d'acquisitions (pour calculer les taux RAF)"
    type: simple
    type_params:
      measure: nb_subscriptions
    filter: |
      {{ Dimension('box_sales_semantic__acquis_status_lvl1') }} <> 'LIVE'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'

  - name: total_active_subscriptions
    label: "Total subscriptions actives"
    description: "Nombre total de subscriptions actives"
    type: simple
    type_params:
      measure: nb_subscriptions
    filter: |
      {{ Dimension('box_sales_semantic__acquis_status_lvl1') }} = 'LIVE'
      AND {{ Dimension('box_sales_semantic__payment_status') }} = 'paid'